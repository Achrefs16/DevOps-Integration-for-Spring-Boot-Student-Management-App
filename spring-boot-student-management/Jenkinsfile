pipeline {
    agent any
    
    environment {
        // Docker Hub credentials
        DOCKER_HUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKER_IMAGE = 'achrefs161/student-management'
        
        // Versioning
        VERSION = "${BUILD_NUMBER}"
        IMAGE_TAG = "v1.${BUILD_NUMBER}"
        
        // SonarQube
        SONAR_TOKEN = credentials('sonarqube-token')
    }
    
    stages {
        stage('ðŸ” Checkout Code') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“¥ RÃ©cupÃ©ration du code depuis GitHub...'
                    echo '================================================'
                }
                checkout scm
                script {
                    sh '''
                        echo "Branch: ${GIT_BRANCH}"
                        echo "Commit: ${GIT_COMMIT}"
                        git log -1 --pretty=format:"%h - %an : %s"
                    '''
                }
            }
        }
        
        stage('ðŸ—ï¸ Build avec Maven') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”¨ Compilation du projet avec Maven...'
                    echo '================================================'
                }
                sh '''
                    mvn clean compile
                    mvn --version
                '''
            }
        }
        
        stage('ðŸ§ª Tests Unitaires') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ§ª ExÃ©cution des tests unitaires...'
                    echo '================================================'
                }
                sh '''
                    mvn test -Dtest=*Test
                '''
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('ðŸ”¬ Tests d\'IntÃ©gration') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”¬ ExÃ©cution des tests d\'intÃ©gration...'
                    echo '================================================'
                }
                sh '''
                    mvn test -Dtest=*IntegrationTest
                '''
            }
        }
        
        stage('ðŸ“Š Rapport de Couverture Jacoco') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“Š GÃ©nÃ©ration du rapport de couverture...'
                    echo '================================================'
                }
                sh '''
                    mvn jacoco:report
                '''
            }
            post {
                always {
                    jacoco(
                        execPattern: '**/target/jacoco.exec',
                        classPattern: '**/target/classes',
                        sourcePattern: '**/src/main/java'
                    )
                }
            }
        }
        
        stage('ðŸ“Š Analyse SonarQube') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“Š Analyse de la qualitÃ© du code avec SonarQube...'
                    echo '================================================'
                }
                withSonarQubeEnv('SonarQube') {
                    sh '''
                        mvn sonar:sonar \
                          -Dsonar.projectKey=student-management \
                          -Dsonar.projectName="Student Management API" \
                          -Dsonar.host.url=http://localhost:9000 \
                          -Dsonar.token=${SONAR_TOKEN}
                    '''
                }
            }
        }
        
        stage('ðŸ›¡ï¸ Quality Gate') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ›¡ï¸ VÃ©rification du Quality Gate SonarQube...'
                    echo '================================================'
                }
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: false
                }
            }
        }
        
        stage('ðŸ“¦ CrÃ©ation du JAR') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“¦ CrÃ©ation du fichier JAR...'
                    echo '================================================'
                }
                sh '''
                    mvn package -DskipTests
                    ls -lh target/*.jar
                '''
            }
            post {
                success {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('ðŸ”’ Scan SÃ©curitÃ© - Code Source (Trivy)') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”’ Scan de sÃ©curitÃ© du code source avec Trivy...'
                    echo '================================================'
                }
                sh '''
                    # Scan du systÃ¨me de fichiers (code source)
                    trivy fs --security-checks vuln,config,secret \
                      --severity HIGH,CRITICAL \
                      --format json \
                      --output trivy-code-report.json \
                      .
                    
                    # Afficher le rÃ©sumÃ©
                    echo ""
                    echo "ðŸ“‹ RÃ©sumÃ© du scan du code source:"
                    trivy fs --security-checks vuln,config,secret \
                      --severity HIGH,CRITICAL \
                      --format table \
                      .
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'trivy-code-report.json', allowEmptyArchive: true
                }
            }
        }
        
        stage('ðŸ³ Construction de l\'image Docker') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ³ Construction de l\'image Docker...'
                    echo '================================================'
                }
                sh """
                    docker build \
                        --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                        --build-arg VERSION=${IMAGE_TAG} \
                        -t ${DOCKER_IMAGE}:${IMAGE_TAG} \
                        -t ${DOCKER_IMAGE}:latest \
                        .
                    
                    docker images | grep ${DOCKER_IMAGE}
                """
            }
        }
        
        stage('ðŸ”’ Scan SÃ©curitÃ© - Image Docker (Trivy)') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”’ Scan de sÃ©curitÃ© de l\'image Docker avec Trivy...'
                    echo '================================================'
                }
                sh """
                    # Scan de l'image Docker
                    trivy image --severity HIGH,CRITICAL \
                      --format json \
                      --output trivy-image-report.json \
                      ${DOCKER_IMAGE}:${IMAGE_TAG}
                    
                    # Afficher le rÃ©sumÃ©
                    echo ""
                    echo "ðŸ“‹ RÃ©sumÃ© du scan de l'image Docker:"
                    trivy image --severity HIGH,CRITICAL \
                      --format table \
                      ${DOCKER_IMAGE}:${IMAGE_TAG}
                    
                    # GÃ©nÃ©rer un rapport HTML
                    trivy image --severity HIGH,CRITICAL \
                      --format template \
                      --template "@/usr/local/share/trivy/templates/html.tpl" \
                      --output trivy-image-report.html \
                      ${DOCKER_IMAGE}:${IMAGE_TAG} || true
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'trivy-image-report.*', allowEmptyArchive: true
                    publishHTML(target: [
                        reportDir: '.',
                        reportFiles: 'trivy-image-report.html',
                        reportName: 'Trivy Security Report',
                        allowMissing: true
                    ])
                }
            }
        }
        
        stage('ðŸ“Š GÃ©nÃ©ration Rapport de SÃ©curitÃ© Complet') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“Š GÃ©nÃ©ration du rapport de sÃ©curitÃ© complet...'
                    echo '================================================'
                }
                sh '''
                    # CrÃ©er un rapport consolidÃ©
                    cat > security-summary.txt << EOF
================================================
ðŸ”’ RAPPORT DE SÃ‰CURITÃ‰ - Build #${BUILD_NUMBER}
================================================

Date: $(date)
Branch: ${GIT_BRANCH}
Commit: ${GIT_COMMIT}

ðŸ“Š Analyse SonarQube:
   URL: http://localhost:9000/dashboard?id=student-management

ðŸ” Scan Trivy - Code Source:
$(trivy fs --severity HIGH,CRITICAL --format json . | jq -r '.Results[].Vulnerabilities | length // 0' | awk '{sum+=$1} END {print "   VulnÃ©rabilitÃ©s HIGH/CRITICAL trouvÃ©es: " sum}')

ðŸ³ Scan Trivy - Image Docker:
$(trivy image --severity HIGH,CRITICAL --format json ${DOCKER_IMAGE}:${IMAGE_TAG} | jq -r '.Results[].Vulnerabilities | length // 0' | awk '{sum+=$1} END {print "   VulnÃ©rabilitÃ©s HIGH/CRITICAL trouvÃ©es: " sum}')

================================================
EOF

                    cat security-summary.txt
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'security-summary.txt', allowEmptyArchive: true
                }
            }
        }
        
        stage('ðŸš€ DÃ©ploiement Local') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸš€ DÃ©ploiement local de l\'application...'
                    echo '================================================'
                }
                sh """
                    # CrÃ©er docker-compose pour le dÃ©ploiement
                    cat > docker-compose.deploy.yml << 'EOF'
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: students-postgres
    environment:
      POSTGRES_DB: students_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - students-network

  app:
    image: ${DOCKER_IMAGE}:${IMAGE_TAG}
    container_name: student-app
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/students_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
    ports:
      - "7000:7000"
    networks:
      - students-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:7000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:

networks:
  students-network:
    driver: bridge
EOF

                    # ArrÃªter les anciens conteneurs
                    docker-compose -f docker-compose.deploy.yml down || true
                    
                    # DÃ©marrer les nouveaux conteneurs
                    docker-compose -f docker-compose.deploy.yml up -d
                    
                    # Attendre le dÃ©marrage
                    echo "Attente du dÃ©marrage de l'application..."
                    sleep 30
                    
                    docker-compose -f docker-compose.deploy.yml ps
                """
            }
        }
        
        stage('ðŸ§ª Tests de FumÃ©e') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ§ª ExÃ©cution des tests de fumÃ©e...'
                    echo '================================================'
                }
                sh '''
                    curl -f http://localhost:7000/actuator/health || exit 1
                    curl -f http://localhost:7000/etudiants || exit 1
                    
                    curl -X POST http://localhost:7000/etudiants \
                      -H "Content-Type: application/json" \
                      -d '{"nom":"Test","prenom":"Security","email":"security@test.com","niveau":"L1"}' \
                      -f || exit 1
                    
                    echo "âœ… Tous les smoke tests sont passÃ©s!"
                '''
            }
        }
        
        stage('ðŸ“¤ Push vers Docker Hub') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“¤ Push de l\'image vers Docker Hub...'
                    echo '================================================'
                }
                sh """
                    echo ${DOCKER_HUB_CREDENTIALS_PSW} | docker login -u ${DOCKER_HUB_CREDENTIALS_USR} --password-stdin
                    
                    docker push ${DOCKER_IMAGE}:${IMAGE_TAG}
                    docker push ${DOCKER_IMAGE}:latest
                    
                    docker logout
                """
            }
        }
        
        stage('âœ… RÃ©sumÃ© Final') {
            steps {
                script {
                    echo '================================================'
                    echo 'âœ… RÃ‰SUMÃ‰ DU PIPELINE COMPLET'
                    echo '================================================'
                    sh """
                        echo "âœ“ Code analysÃ©: ${GIT_BRANCH}"
                        echo "âœ“ Tests unitaires: PASSED"
                        echo "âœ“ Tests d'intÃ©gration: PASSED"
                        echo "âœ“ Couverture de code: Rapport Jacoco gÃ©nÃ©rÃ©"
                        echo "âœ“ QualitÃ© du code: SonarQube - http://localhost:9000"
                        echo "âœ“ SÃ©curitÃ© code source: Trivy scan effectuÃ©"
                        echo "âœ“ SÃ©curitÃ© image Docker: Trivy scan effectuÃ©"
                        echo "âœ“ Image Docker: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                        echo "âœ“ DÃ©ploiement local: http://localhost:7000"
                        echo "âœ“ Push Docker Hub: SUCCESS"
                        echo ""
                        echo "ðŸŽ‰ Pipeline terminÃ© avec succÃ¨s!"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Pipeline exÃ©cutÃ© avec succÃ¨s!'
            echo 'ðŸ“Š SonarQube: http://localhost:9000/dashboard?id=student-management'
            echo 'ðŸš€ Application: http://localhost:7000'
        }
        failure {
            echo 'âŒ Pipeline Ã©chouÃ©!'
            sh '''
                docker-compose -f docker-compose.deploy.yml logs app || true
            '''
        }
        always {
            echo 'ðŸ§¹ Nettoyage...'
            sh '''
                docker image prune -f
            '''
        }
    }
}
