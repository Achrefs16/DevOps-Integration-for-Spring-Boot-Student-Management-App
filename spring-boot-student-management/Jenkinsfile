pipeline {
    agent any
    
    environment {
        DOCKER_HUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKER_IMAGE = 'achrefs161/student-management'
        VERSION = "${BUILD_NUMBER}"
        IMAGE_TAG = "v1.${BUILD_NUMBER}"
        SONAR_TOKEN = credentials('sonarqube-token')
        
        // DÃ©finir le rÃ©pertoire de travail
        PROJECT_DIR = 'spring-boot-student-management'
    }
    
    stages {
        stage('ðŸ” Checkout Code') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“¥ RÃ©cupÃ©ration du code depuis GitHub...'
                    echo '================================================'
                }
                checkout scm
                script {
                    sh '''
                        echo "Contenu de la racine:"
                        ls -la
                        
                        echo ""
                        echo "Contenu du projet:"
                        ls -la ${PROJECT_DIR}/
                        
                        echo ""
                        echo "VÃ©rification du pom.xml:"
                        if [ -f ${PROJECT_DIR}/pom.xml ]; then
                            echo "âœ… pom.xml trouvÃ© dans ${PROJECT_DIR}/"
                        else
                            echo "âŒ pom.xml NON trouvÃ©!"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('ðŸ—ï¸ Build avec Maven') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”¨ Compilation du projet avec Maven...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    sh '''
                        mvn clean compile
                        mvn --version
                    '''
                }
            }
        }
        
        stage('ðŸ§ª Tests Unitaires') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ§ª ExÃ©cution des tests unitaires...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    sh '''
                        mvn test -Dtest=*Test
                    '''
                }
            }
            post {
                always {
                    junit "${PROJECT_DIR}/**/target/surefire-reports/*.xml"
                }
            }
        }
        
        stage('ðŸ”¬ Tests d\'IntÃ©gration') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”¬ ExÃ©cution des tests d\'intÃ©gration...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    sh '''
                        mvn test -Dtest=*IntegrationTest
                    '''
                }
            }
        }
        
        stage('ðŸ“Š Rapport de Couverture Jacoco') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“Š GÃ©nÃ©ration du rapport de couverture...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    sh '''
                        mvn jacoco:report
                    '''
                }
            }
            post {
                always {
                    jacoco(
                        execPattern: "${PROJECT_DIR}/**/target/jacoco.exec",
                        classPattern: "${PROJECT_DIR}/**/target/classes",
                        sourcePattern: "${PROJECT_DIR}/**/src/main/java"
                    )
                }
            }
        }
        
        stage('ðŸ“Š Analyse SonarQube') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“Š Analyse de la qualitÃ© du code avec SonarQube...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                            mvn sonar:sonar \
                              -Dsonar.projectKey=student-management \
                              -Dsonar.projectName="Student Management API" \
                              -Dsonar.host.url=http://localhost:9000 \
                              -Dsonar.token=${SONAR_TOKEN}
                        '''
                    }
                }
            }
        }
        
        stage('ðŸ›¡ï¸ Quality Gate') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ›¡ï¸ VÃ©rification du Quality Gate SonarQube...'
                    echo '================================================'
                }
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: false
                }
            }
        }
        
        stage('ðŸ“¦ CrÃ©ation du JAR') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“¦ CrÃ©ation du fichier JAR...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    sh '''
                        mvn package -DskipTests
                        ls -lh target/*.jar
                    '''
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: "${PROJECT_DIR}/target/*.jar", fingerprint: true
                }
            }
        }
        
        stage('ðŸ”’ Scan SÃ©curitÃ© - Code Source (Trivy)') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”’ Scan de sÃ©curitÃ© du code source avec Trivy...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    sh '''
                        trivy fs --security-checks vuln,config,secret \
                          --severity HIGH,CRITICAL \
                          --format json \
                          --output trivy-code-report.json \
                          .
                        
                        echo ""
                        echo "ðŸ“‹ RÃ©sumÃ© du scan du code source:"
                        trivy fs --security-checks vuln,config,secret \
                          --severity HIGH,CRITICAL \
                          --format table \
                          .
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: "${PROJECT_DIR}/trivy-code-report.json", allowEmptyArchive: true
                }
            }
        }
        
        stage('ðŸ³ Construction de l\'image Docker') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ³ Construction de l\'image Docker...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    sh """
                        docker build \
                            --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                            --build-arg VERSION=${IMAGE_TAG} \
                            -t ${DOCKER_IMAGE}:${IMAGE_TAG} \
                            -t ${DOCKER_IMAGE}:latest \
                            .
                        
                        docker images | grep ${DOCKER_IMAGE}
                    """
                }
            }
        }
        
        stage('ðŸ”’ Scan SÃ©curitÃ© - Image Docker (Trivy)') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”’ Scan de sÃ©curitÃ© de l\'image Docker avec Trivy...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    sh """
                        trivy image --severity HIGH,CRITICAL \
                          --format json \
                          --output trivy-image-report.json \
                          ${DOCKER_IMAGE}:${IMAGE_TAG}
                        
                        echo ""
                        echo "ðŸ“‹ RÃ©sumÃ© du scan de l'image Docker:"
                        trivy image --severity HIGH,CRITICAL \
                          --format table \
                          ${DOCKER_IMAGE}:${IMAGE_TAG}
                        
                        trivy image --severity HIGH,CRITICAL \
                          --format template \
                          --template "@/usr/local/share/trivy/templates/html.tpl" \
                          --output trivy-image-report.html \
                          ${DOCKER_IMAGE}:${IMAGE_TAG} || true
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: "${PROJECT_DIR}/trivy-image-report.*", allowEmptyArchive: true
                    publishHTML(target: [
                        reportDir: "${PROJECT_DIR}",
                        reportFiles: 'trivy-image-report.html',
                        reportName: 'Trivy Security Report',
                        allowMissing: true
                    ])
                }
            }
        }
        
        stage('ðŸš€ DÃ©ploiement Local') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸš€ DÃ©ploiement local de l\'application...'
                    echo '================================================'
                }
                dir("${PROJECT_DIR}") {
                    sh """
                        cat > docker-compose.deploy.yml << 'EOF'
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: students-postgres
    environment:
      POSTGRES_DB: students_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - students-network

  app:
    image: ${DOCKER_IMAGE}:${IMAGE_TAG}
    container_name: student-app
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/students_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
    ports:
      - "7000:7000"
    networks:
      - students-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:7000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:

networks:
  students-network:
    driver: bridge
EOF

                        docker-compose -f docker-compose.deploy.yml down || true
                        docker-compose -f docker-compose.deploy.yml up -d
                        
                        echo "Attente du dÃ©marrage..."
                        sleep 30
                        
                        docker-compose -f docker-compose.deploy.yml ps
                    """
                }
            }
        }
        
        stage('ðŸ§ª Tests de FumÃ©e') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ§ª ExÃ©cution des tests de fumÃ©e...'
                    echo '================================================'
                }
                sh '''
                    curl -f http://localhost:7000/actuator/health || exit 1
                    curl -f http://localhost:7000/etudiants || exit 1
                    
                    curl -X POST http://localhost:7000/etudiants \
                      -H "Content-Type: application/json" \
                      -d '{"nom":"Test","prenom":"Security","email":"security@test.com","niveau":"L1"}' \
                      -f || exit 1
                    
                    echo "âœ… Tous les smoke tests sont passÃ©s!"
                '''
            }
        }
        
        stage('ðŸ“¤ Push vers Docker Hub') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“¤ Push de l\'image vers Docker Hub...'
                    echo '================================================'
                }
                sh """
                    echo ${DOCKER_HUB_CREDENTIALS_PSW} | docker login -u ${DOCKER_HUB_CREDENTIALS_USR} --password-stdin
                    
                    docker push ${DOCKER_IMAGE}:${IMAGE_TAG}
                    docker push ${DOCKER_IMAGE}:latest
                    
                    docker logout
                """
            }
        }
        
        stage('âœ… RÃ©sumÃ© Final') {
            steps {
                script {
                    echo '================================================'
                    echo 'âœ… RÃ‰SUMÃ‰ DU PIPELINE COMPLET'
                    echo '================================================'
                    sh """
                        echo "âœ“ Projet: ${PROJECT_DIR}"
                        echo "âœ“ Tests: PASSED"
                        echo "âœ“ SonarQube: http://localhost:9000"
                        echo "âœ“ SÃ©curitÃ©: Trivy scans effectuÃ©s"
                        echo "âœ“ Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                        echo "âœ“ App: http://localhost:7000"
                        echo ""
                        echo "ðŸŽ‰ Pipeline terminÃ© avec succÃ¨s!"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Pipeline exÃ©cutÃ© avec succÃ¨s!'
        }
        failure {
            echo 'âŒ Pipeline Ã©chouÃ©!'
        }
        always {
            echo 'ðŸ§¹ Nettoyage...'
            sh 'docker image prune -f'
        }
    }
}
