pipeline {
    agent any
    
    environment {
        // Docker Hub credentials
        DOCKER_HUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKER_IMAGE = 'achrefs16/student-management'
        
        // Versioning
        VERSION = "${BUILD_NUMBER}"
        IMAGE_TAG = "v1.${BUILD_NUMBER}"
    }
    
    stages {
        stage('ðŸ” Checkout Code') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“¥ RÃ©cupÃ©ration du code depuis GitHub...'
                    echo '================================================'
                }
                checkout scm
                script {
                    sh '''
                        echo "Branch: ${GIT_BRANCH}"
                        echo "Commit: ${GIT_COMMIT}"
                        git log -1 --pretty=format:"%h - %an : %s"
                    '''
                }
            }
        }
        
        stage('ðŸ—ï¸ Build avec Maven') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”¨ Compilation du projet avec Maven...'
                    echo '================================================'
                }
                sh '''
                    mvn clean compile
                    mvn --version
                '''
            }
        }
        
        stage('ðŸ§ª Tests Unitaires') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ§ª ExÃ©cution des tests unitaires...'
                    echo '================================================'
                }
                sh '''
                    mvn test -Dtest=*Test
                    echo "âœ… Tests unitaires terminÃ©s!"
                '''
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                    publishHTML(target: [
                        reportDir: 'target/surefire-reports',
                        reportFiles: 'index.html',
                        reportName: 'Test Report'
                    ])
                }
            }
        }
        
        stage('ðŸ”¬ Tests d\'IntÃ©gration') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ”¬ ExÃ©cution des tests d\'intÃ©gration...'
                    echo '================================================'
                }
                sh '''
                    mvn test -Dtest=*IntegrationTest
                    echo "âœ… Tests d'intÃ©gration terminÃ©s!"
                '''
            }
        }
        
        stage('ðŸ“Š Rapport de Couverture') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“Š GÃ©nÃ©ration du rapport de couverture...'
                    echo '================================================'
                }
                sh '''
                    mvn jacoco:report
                    echo "âœ… Rapport de couverture gÃ©nÃ©rÃ©!"
                '''
            }
            post {
                always {
                    jacoco(
                        execPattern: '**/target/jacoco.exec',
                        classPattern: '**/target/classes',
                        sourcePattern: '**/src/main/java'
                    )
                }
            }
        }
        
        stage('ðŸ“¦ CrÃ©ation du JAR') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“¦ CrÃ©ation du fichier JAR...'
                    echo '================================================'
                }
                sh '''
                    mvn package -DskipTests
                    echo "âœ… JAR crÃ©Ã© avec succÃ¨s!"
                    ls -lh target/*.jar
                '''
            }
            post {
                success {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('ðŸ³ Construction de l\'image Docker') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ³ Construction de l\'image Docker...'
                    echo '================================================'
                }
                sh """
                    docker build \
                        --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                        --build-arg VERSION=${IMAGE_TAG} \
                        -t ${DOCKER_IMAGE}:${IMAGE_TAG} \
                        -t ${DOCKER_IMAGE}:latest \
                        .
                    
                    echo "âœ… Image Docker construite!"
                    docker images | grep ${DOCKER_IMAGE}
                """
            }
        }
        
        stage('ðŸš€ DÃ©ploiement Local - PostgreSQL') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ˜ DÃ©marrage de PostgreSQL...'
                    echo '================================================'
                }
                sh '''
                    # ArrÃªter les anciens conteneurs
                    docker-compose down || true
                    
                    # DÃ©marrer PostgreSQL
                    docker-compose up -d postgres
                    
                    # Attendre que PostgreSQL soit prÃªt
                    echo "Attente du dÃ©marrage de PostgreSQL..."
                    sleep 15
                    
                    # VÃ©rifier PostgreSQL
                    docker-compose ps
                    echo "âœ… PostgreSQL dÃ©marrÃ©!"
                '''
            }
        }
        
        stage('ðŸš€ DÃ©ploiement Local - Application') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸš€ DÃ©ploiement de l\'application...'
                    echo '================================================'
                }
                sh """
                    # CrÃ©er un docker-compose spÃ©cifique pour le dÃ©ploiement
                    cat > docker-compose.deploy.yml << 'EOF'
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: students-postgres
    environment:
      POSTGRES_DB: students_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - students-network

  app:
    image: ${DOCKER_IMAGE}:${IMAGE_TAG}
    container_name: student-app
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/students_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
    ports:
      - "7000:7000"
    networks:
      - students-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:7000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:

networks:
  students-network:
    driver: bridge
EOF

                    # DÃ©ployer l'application
                    docker-compose -f docker-compose.deploy.yml up -d app
                    
                    # Attendre le dÃ©marrage
                    echo "Attente du dÃ©marrage de l'application..."
                    sleep 30
                    
                    # VÃ©rifier les conteneurs
                    docker-compose -f docker-compose.deploy.yml ps
                """
            }
        }
        
        stage('ðŸ§ª Tests de FumÃ©e (Smoke Tests)') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ§ª ExÃ©cution des tests de fumÃ©e...'
                    echo '================================================'
                }
                sh '''
                    # Test du health check
                    echo "Test 1: Health Check..."
                    curl -f http://localhost:7000/actuator/health || exit 1
                    echo "âœ… Health check OK!"
                    
                    # Test de l'endpoint principal
                    echo "Test 2: GET /etudiants..."
                    curl -f http://localhost:7000/etudiants || exit 1
                    echo "âœ… Endpoint /etudiants OK!"
                    
                    # Test de crÃ©ation d'un Ã©tudiant
                    echo "Test 3: POST /etudiants..."
                    curl -X POST http://localhost:7000/etudiants \
                      -H "Content-Type: application/json" \
                      -d '{"nom":"Test","prenom":"Jenkins","email":"test@jenkins.com","niveau":"L1"}' \
                      -f || exit 1
                    echo "âœ… CrÃ©ation d'Ã©tudiant OK!"
                    
                    echo ""
                    echo "âœ… Tous les smoke tests sont passÃ©s avec succÃ¨s!"
                '''
            }
        }
        
        stage('ðŸ“¤ Push vers Docker Hub') {
            steps {
                script {
                    echo '================================================'
                    echo 'ðŸ“¤ Push de l\'image vers Docker Hub...'
                    echo '================================================'
                }
                sh """
                    echo "Login to Docker Hub..."
                    echo ${DOCKER_HUB_CREDENTIALS_PSW} | docker login -u ${DOCKER_HUB_CREDENTIALS_USR} --password-stdin
                    
                    echo "Pushing ${DOCKER_IMAGE}:${IMAGE_TAG}..."
                    docker push ${DOCKER_IMAGE}:${IMAGE_TAG}
                    
                    echo "Pushing ${DOCKER_IMAGE}:latest..."
                    docker push ${DOCKER_IMAGE}:latest
                    
                    echo "âœ… Images pushÃ©es avec succÃ¨s!"
                    
                    docker logout
                """
            }
        }
        
        stage('âœ… RÃ©sumÃ© du Pipeline') {
            steps {
                script {
                    echo '================================================'
                    echo 'âœ… RÃ‰SUMÃ‰ DU PIPELINE'
                    echo '================================================'
                    sh """
                        echo "ðŸ“¥ Code: ${GIT_BRANCH} - ${GIT_COMMIT}"
                        echo "ðŸ§ª Tests unitaires: PASSED"
                        echo "ðŸ”¬ Tests d'intÃ©gration: PASSED"
                        echo "ðŸ“¦ JAR: target/student-management-1.0.0.jar"
                        echo "ðŸ³ Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                        echo "ðŸš€ DÃ©ployÃ© localement: http://localhost:7000"
                        echo "ðŸ“¤ Pushed vers Docker Hub: âœ“"
                        echo ""
                        echo "ðŸŽ‰ Pipeline terminÃ© avec succÃ¨s!"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Pipeline exÃ©cutÃ© avec succÃ¨s!'
            echo 'Application disponible sur: http://localhost:7000'
        }
        failure {
            echo 'âŒ Pipeline Ã©chouÃ©!'
            sh '''
                echo "Logs des conteneurs:"
                docker-compose -f docker-compose.deploy.yml logs app || true
            '''
        }
        always {
            echo 'ðŸ§¹ Nettoyage...'
            sh '''
                # Garder l'application en cours d'exÃ©cution pour les tests
                # Si vous voulez arrÃªter aprÃ¨s le build:
                # docker-compose -f docker-compose.deploy.yml down
                
                # Nettoyer les images inutilisÃ©es
                docker image prune -f
            '''
        }
    }
}
