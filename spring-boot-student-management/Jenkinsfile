pipeline {
    agent any
    
    environment {
        // Docker Hub credentials (√† configurer dans Jenkins)
        DOCKER_HUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKER_IMAGE = 'achrefs161/student-management'
        
        // Versioning
        VERSION = "${BUILD_NUMBER}"
        IMAGE_TAG = "v1.${BUILD_NUMBER}"
    }
    
    stages {
        stage('üîç Checkout Code') {
            steps {
                script {
                    echo '================================================'
                    echo 'üì• R√©cup√©ration du code depuis GitHub...'
                    echo '================================================'
                }
                checkout scm
                script {
                    // Afficher les informations Git
                    sh '''
                        echo "Branch: ${GIT_BRANCH}"
                        echo "Commit: ${GIT_COMMIT}"
                        git log -1 --pretty=format:"%h - %an : %s"
                    '''
                }
            }
        }
        
        stage('üèóÔ∏è Build avec Maven') {
            steps {
                script {
                    echo '================================================'
                    echo 'üî® Compilation du projet avec Maven...'
                    echo '================================================'
                }
                sh '''
                    echo "Nettoyage et compilation..."
                    mvn clean compile
                    
                    echo "Affichage de la version Maven..."
                    mvn --version
                '''
            }
        }
        
        stage('üì¶ Cr√©ation du JAR') {
            steps {
                script {
                    echo '================================================'
                    echo 'üì¶ Cr√©ation du fichier JAR...'
                    echo '================================================'
                }
                sh '''
                    mvn package -DskipTests
                    
                    echo "‚úÖ JAR cr√©√© avec succ√®s!"
                    ls -lh target/*.jar
                '''
            }
            post {
                success {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('üê≥ Construction de l\'image Docker') {
            steps {
                script {
                    echo '================================================'
                    echo 'üê≥ Construction de l\'image Docker...'
                    echo '================================================'
                }
                sh """
                    echo "Building Docker image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                    
                    docker build \
                        --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                        --build-arg VERSION=${IMAGE_TAG} \
                        -t ${DOCKER_IMAGE}:${IMAGE_TAG} \
                        -t ${DOCKER_IMAGE}:latest \
                        .
                    
                    echo "‚úÖ Image Docker construite avec succ√®s!"
                    docker images | grep ${DOCKER_IMAGE}
                """
            }
        }
        
        stage('üîç Inspection de l\'image') {
            steps {
                script {
                    echo '================================================'
                    echo 'üîç Inspection de l\'image Docker...'
                    echo '================================================'
                }
                sh """
                    echo "Taille de l'image:"
                    docker images ${DOCKER_IMAGE}:${IMAGE_TAG} --format "{{.Repository}}:{{.Tag}} - {{.Size}}"
                    
                    echo "\nInformations d√©taill√©es:"
                    docker inspect ${DOCKER_IMAGE}:${IMAGE_TAG} --format='{{json .Config.Labels}}' | jq '.'
                """
            }
        }
        
        stage('üì§ Push vers Docker Hub') {
            steps {
                script {
                    echo '================================================'
                    echo 'üì§ Push de l\'image vers Docker Hub...'
                    echo '================================================'
                }
                sh """
                    echo "Login to Docker Hub..."
                    echo ${DOCKER_HUB_CREDENTIALS_PSW} | docker login -u ${DOCKER_HUB_CREDENTIALS_USR} --password-stdin
                    
                    echo "Pushing ${DOCKER_IMAGE}:${IMAGE_TAG}..."
                    docker push ${DOCKER_IMAGE}:${IMAGE_TAG}
                    
                    echo "Pushing ${DOCKER_IMAGE}:latest..."
                    docker push ${DOCKER_IMAGE}:latest
                    
                    echo "‚úÖ Images push√©es avec succ√®s!"
                    
                    docker logout
                """
            }
        }
        
        stage('‚úÖ R√©sum√© Build & Docker') {
            steps {
                script {
                    echo '================================================'
                    echo '‚úÖ R√âSUM√â DE L\'√âTAPE BUILD & DOCKER'
                    echo '================================================'
                    sh """
                        echo "‚úì Code r√©cup√©r√© depuis: ${GIT_BRANCH}"
                        echo "‚úì Commit: ${GIT_COMMIT}"
                        echo "‚úì JAR cr√©√©: target/student-management-1.0.0.jar"
                        echo "‚úì Image Docker: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                        echo "‚úì Image Docker: ${DOCKER_IMAGE}:latest"
                        echo "‚úì Images disponibles sur Docker Hub"
                        echo ""
                        echo "üéâ √âtape 1 termin√©e avec succ√®s!"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Pipeline Build & Docker ex√©cut√© avec succ√®s!'
        }
        failure {
            echo '‚ùå Pipeline Build & Docker √©chou√©!'
        }
        always {
            echo 'üßπ Nettoyage des images Docker locales...'
            sh '''
                docker image prune -f
            '''
        }
    }
}
